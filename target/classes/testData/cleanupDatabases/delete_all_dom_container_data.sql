CREATE SCHEMA IF NOT EXISTS dom_container;

/* ---------------------------------------------------- */
/*  Generated by Enterprise Architect Version 13.5 		*/
/*  Created On : 13-Jan-2020 11:45:19 				*/
/*  DBMS       : PostgreSQL 						*/
/* ---------------------------------------------------- */

/* Drop Tables */

DROP TABLE IF EXISTS dom_container.SYS_PARAM CASCADE
;

DROP TABLE IF EXISTS dom_container.DOM_CONTAINER CASCADE
;

DROP TABLE IF EXISTS dom_container.DOM_CONTAINER_RESOURCE CASCADE
;


CREATE TABLE dom_container.SYS_PARAM
(
	SYS_PARAM_ID bigserial NOT NULL,    -- Internal Id. Primary key of the table.
	PAR_NAME varchar(100) NOT NULL,    -- Name of the parameter.  This must be unique for all rows in the table.
	PAR_VALUE varchar(300) NOT NULL,    -- Value of the parameter.
	PAR_DESCRIPTION varchar(300) NULL    -- Description of the parameter. It should describe the meaning of the specific parameter or for what purpose the parameter is needed.
)
;

CREATE TABLE dom_container.DOM_CONTAINER
(
	DOM_CONTAINER_ID bigserial NOT NULL,    -- The artificial PK.  The internal/resource ID of the DOM container.
	PART_NUMBER varchar(50) NOT NULL,    -- The software part number that together with SW_VERSION builds the business key for the /containers resource.  The part number would be an additional way for the business logic to find the corresponding package from the dom-content-service/packages resource. (If no PACKAGE_ID is provided initially)  Therefore the DOM_CONTAINER.PART_NUMBER should be corresponding to the DOM_PACKAGE.PART_NUMBER for the same package. (where DOM_CONTAINER.PACKAGE_ID=DOM_PACKAGE.DOM_PACKAGE_ID)
	SW_VERSION varchar(20) NOT NULL,    -- The software version that together with PART_NUMBER builds the business key for the /containers resource.
	CONTAINER_STATUS varchar(50) NULL,    -- Status of the container creation. (possible values are 'error', 'started', 'completed', 'overwritten')
	CONTAINER_TYPE varchar(20) NULL,    -- Type of the container(e.g. ‘ext4’).
	PACKAGE_ID bigint NULL,    -- The reference to the /packages resource. (Origin Vehicle Backend DB: DOM_PACKAGE.DOM_PACKAGE_ID)  In the current use-case this attribute is not a part of the POST /containers request.  The PACKAGE_ID shall be determined via the PART_NUMBER (using an unspecific GET dom-content-service/packages request with the part number as parameter).
	PACKAGE_LOCATION_URL varchar(2048) NULL,    -- The URL of the DOM package resource (/packages).  (Origin Vehicle Backend DB: DOM_PACKAGE_RESOURCE.RESOURCE_URL)
	PACKAGE_TYPE text NULL,    -- The type of the DOM package resource (/packages). (Origin Vehicle Backend DB: DOM_PACKAGE.PACKAGE_TYPE)  (possible values are 'online', 'offline')
	PACKAGE_DOM_TYPE text NULL,    -- The type of the Digital Owner's Manual of the DOM package resource (/packages). (Origin Vehicle Backend DB: DOM_PACKAGE.DOM_TYPE)  (possible values are 'DOM1', 'DOM2', 'DOM3')
	LOG text NULL,    -- Logging of container creation with JSON objects according to the general logging approach.
	CREATION_TIMESTAMP timestamp(6) with time zone NOT NULL,    -- Creation timestamp of the DOM container using format YYYY-MM-DDThh:mm:ss.fff  The value is created with now() during creation of the resource.
	MODIFICATION_TIMESTAMP timestamp(6) with time zone NULL    -- Point in time (date and time), when the row was updated.  Is initially set to NULL, when inserting a row.
)
;

CREATE TABLE dom_container.DOM_CONTAINER_RESOURCE
(
	DOM_CONTAINER_RESOURCE_ID bigserial NOT NULL,    -- The artificial PK.  The internal ID of the DOM container resource.
	DOM_CONTAINER_ID bigint NOT NULL,    -- The reference to the DOM_CONTAINER this resource belongs to.
	ID_TAG varchar(50) NOT NULL,    -- An identifying tag/name for the kind of resource that is stored.  Values are: 	- 'DOM' 	- 'OA' 	- 'README' 	- 'BIN' 	- 'ODX'  Note that DOM_CONTAINER_ID and ID_TAG build a secondary key for this table. One ID must only exist once for one container.
	RESOURCE_URL varchar(2048) NOT NULL,    -- This is the full/complete URL to the object/resource in the artifactory.  E.g. 'https://ntg7oa.mercedes-benz.com/artifactory/5471248923493484/223123.bin'
	ESTAND text NULL    -- This string is used to provide the value for 'build' when creating the 'logistic.txt'.  E.g. 12.0
)
;

/* Create Primary Keys, Indexes, Uniques, Checks */

ALTER TABLE dom_container.SYS_PARAM ADD CONSTRAINT PK_SYS_PARAM
	PRIMARY KEY (SYS_PARAM_ID)
;

ALTER TABLE dom_container.SYS_PARAM
  ADD CONSTRAINT UK_SYS_PARAM_SEC_KEY UNIQUE (PAR_NAME)
;

ALTER TABLE dom_container.DOM_CONTAINER ADD CONSTRAINT PK_DOM_CONTAINER
	PRIMARY KEY (DOM_CONTAINER_ID)
;

CREATE INDEX IX_PACKAGE_ID ON dom_container.DOM_CONTAINER (PACKAGE_ID ASC)
;

ALTER TABLE dom_container.DOM_CONTAINER_RESOURCE ADD CONSTRAINT PK_DOM_CONTAINER_RESOURCE
	PRIMARY KEY (DOM_CONTAINER_RESOURCE_ID)
;

ALTER TABLE dom_container.DOM_CONTAINER_RESOURCE
  ADD CONSTRAINT UK_DOM_CONTAINER_RESOURCE_SEC_KEY UNIQUE (DOM_CONTAINER_ID,ID_TAG)
;

CREATE INDEX IXFK_DOM_CONTAINER_RESOURCE_DOM_CONTAINER ON dom_container.DOM_CONTAINER_RESOURCE (DOM_CONTAINER_ID ASC)
;

/* Create Foreign Key Constraints */

ALTER TABLE dom_container.DOM_CONTAINER_RESOURCE ADD CONSTRAINT FK_DOM_CONTAINER_RESOURCE_DOM_CONTAINER
	FOREIGN KEY (DOM_CONTAINER_ID) REFERENCES dom_container.DOM_CONTAINER (DOM_CONTAINER_ID) ON DELETE No Action ON UPDATE No Action
;

/* Create Table Comments, Sequences for Autonumber Columns */

COMMENT ON TABLE dom_container.SYS_PARAM
	IS 'This table is used to store the names and values of system parameters, which are valid for the whole system, like software versions, paths, etc.'
;

COMMENT ON COLUMN dom_container.SYS_PARAM.SYS_PARAM_ID
	IS 'Internal Id. Primary key of the table.'
;

COMMENT ON COLUMN dom_container.SYS_PARAM.PAR_NAME
	IS 'Name of the parameter.  This must be unique for all rows in the table.'
;

COMMENT ON COLUMN dom_container.SYS_PARAM.PAR_VALUE
	IS 'Value of the parameter.'
;

COMMENT ON COLUMN dom_container.SYS_PARAM.PAR_DESCRIPTION
	IS 'Description of the parameter. It should describe the meaning of the specific parameter or for what purpose the parameter is needed.'
;



COMMENT ON TABLE dom_container.DOM_CONTAINER
	IS 'This is the table for the resource /containers of the DOM Container service.   Actually the attribute PACKAGE_ID is the resource id of the resource /packages of the DOM Content service and hence it should match the attribute DOM_PACKAGE_ID of the table DOM_PACKAGE (Vehicle Backend DB).'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER.DOM_CONTAINER_ID
	IS 'The artificial PK.  The internal/resource ID of the DOM container.'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER.PART_NUMBER
	IS 'The software part number that together with SW_VERSION builds the business key for the /containers resource.  The part number would be an additional way for the business logic to find the corresponding package from the dom-content-service/packages resource. (If no PACKAGE_ID is provided initially)  Therefore the DOM_CONTAINER.PART_NUMBER should be corresponding to the DOM_PACKAGE.PART_NUMBER for the same package. (where DOM_CONTAINER.PACKAGE_ID=DOM_PACKAGE.DOM_PACKAGE_ID)'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER.SW_VERSION
	IS 'The software version that together with PART_NUMBER builds the business key for the /containers resource.'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER.CONTAINER_STATUS
	IS 'Status of the container creation. (possible values are ''error'', ''started'', ''completed'', ''overwritten'')'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER.CONTAINER_TYPE
	IS 'Type of the container(e.g. ‘ext4’).'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER.PACKAGE_ID
	IS 'The reference to the /packages resource. (Origin Vehicle Backend DB: DOM_PACKAGE.DOM_PACKAGE_ID)  In the current use-case this attribute is not a part of the POST /containers request.  The PACKAGE_ID shall be determined via the PART_NUMBER (using an unspecific GET dom-content-service/packages request with the part number as parameter).'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER.PACKAGE_LOCATION_URL
	IS 'The URL of the DOM package resource (/packages).  (Origin Vehicle Backend DB: DOM_PACKAGE_RESOURCE.RESOURCE_URL)'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER.PACKAGE_TYPE
	IS 'The type of the DOM package resource (/packages). (Origin Vehicle Backend DB: DOM_PACKAGE.PACKAGE_TYPE)  (possible values are ''online'', ''offline'')'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER.PACKAGE_DOM_TYPE
	IS 'The type of the Digital Owner''s Manual of the DOM package resource (/packages). (Origin Vehicle Backend DB: DOM_PACKAGE.DOM_TYPE)  (possible values are ''DOM1'', ''DOM2'', ''DOM3'')'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER.LOG
	IS 'Logging of container creation with JSON objects according to the general logging approach.'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER.CREATION_TIMESTAMP
	IS 'Creation timestamp of the DOM container using format YYYY-MM-DDThh:mm:ss.fff  The value is created with now() during creation of the resource.'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER.MODIFICATION_TIMESTAMP
	IS 'Point in time (date and time), when the row was updated.  Is initially set to NULL, when inserting a row.'
;



COMMENT ON TABLE dom_container.DOM_CONTAINER_RESOURCE
	IS 'This table is depending in a 1:n relationship from table DOM_CONTAINER to store a list of resources.  One container resource can contain several resource objects that are stored in an artifactory.  Each entry in this table contains as payload the distinct ID_TAG (ID_TAG is unique for one /containers resource) and the complete RESOURCE_URL.'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER_RESOURCE.DOM_CONTAINER_RESOURCE_ID
	IS 'The artificial PK.  The internal ID of the DOM container resource.'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER_RESOURCE.DOM_CONTAINER_ID
	IS 'The reference to the DOM_CONTAINER this resource belongs to. '
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER_RESOURCE.ID_TAG
	IS 'An identifying tag/name for the kind of resource that is stored.  Values are: 	- ''DOM'' 	- ''OA'' 	- ''README'' 	- ''BIN'' 	- ''ODX''  Note that DOM_CONTAINER_ID and ID_TAG build a secondary key for this table. One ID must only exist once for one container.'
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER_RESOURCE.RESOURCE_URL
	IS 'This is the full/complete URL to the object/resource in the artifactory.  E.g. ''https://ntg7oa.mercedes-benz.com/artifactory/5471248923493484/223123.bin'''
;

COMMENT ON COLUMN dom_container.DOM_CONTAINER_RESOURCE.ESTAND
	IS 'This string is used to provide the value for ''build'' when creating the ''logistic.txt''.  E.g. 12.0'
;


-- This script inserts initial data into the DOM Container DB.
-- It is used during the installation of a new DOM Container DB after creating the empty tables.
-- ---------------------------------------------------------------------------------------------

-------------------------------------------------------------------
-- System Parameters
-------------------------------------------------------------------
-- System parameter for the version of the DOM Container DB:
	INSERT INTO dom_container.sys_param (sys_param_id, par_name, par_value, par_description)
		VALUES (DEFAULT, 'DOM_CONTAINER_DB_VERSION', '1.2.1', 'Version of the DOM Container DB');
